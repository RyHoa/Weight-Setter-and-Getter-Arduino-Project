//
//
//


#include<SPI.h>
#include <LiquidCrystal.h>





//Used this website to learn more about LCD screens and the idea on how to code the LCD:
//https://docs.arduino.cc/learn/electronics/lcd-displays
const int rs = 11, en = 10, d4 = 9, d5 = 8, d6 = 7, d7 = 6; //set the values of the arduino pins to the LCD pins
LiquidCrystal LCD(rs, en, d4, d5, d6, d7); //created an instance of the LCD

float weight = 100;


//set weight
int outA =13;
int outB = 12;
bool currA;
bool prevA = 1; 


volatile bool setWeightFlag = false;
int setWeightPin = 2;

//spi setup 
byte weightLoss; 



void setup() 
{
  LCD.begin(16,2); //set the 16 columns and 2 rows in the LCD 
  Serial.begin(9600); //set Commns with serial

  //set pins to INPUT pin
  pinMode(outA, INPUT);
  pinMode(outB, INPUT);
  pinMode(setWeightPin, INPUT);

  //ISR command on setWeightPin to call toggleWeight on the RISING edge
  attachInterrupt(digitalPinToInterrupt(setWeightPin), toggleWeight, RISING); 

  //SPI setup
  SPCR |= 0b11000000; //turns on SPIE (enable SPI interrupt), turns on SPE (enables SPI)
  //pinMode(MISO, OUTPUT); //for slave to send Data to master

  
}

ISR (SPI_STC_vect) //SPI interrupt routine
{
  weightLoss = SPDR; //read data from the SPI data register
  weight -= weightLoss; //adjust the weight from the data received
}



void loop() 
{
  
  setWeight();
  printLCD();
}

//method to print weight on the LCD screen
void printLCD()
{
  
  LCD.setCursor(0,0); //set location of the text on the LCD   
  LCD.print(weight);
  LCD.print("lbs");
  delay(5); //delay of 5 ms to prevent LCD flickering issue
  LCD.clear(); //clears the LCD
}

//method to set weight
void setWeight()
{
  if(setWeightFlag)
  {
    currA = digitalRead(outA);
    
    if(currA != prevA && currA)
    {
      if(digitalRead(outB))
      {
        weight += 10;
      }
      else if(!digitalRead(outB))
      {
        weight -= 10;
      }
      prevA = currA;
    }
    
  }
  
}

void toggleWeight()
{
  setWeightFlag = !setWeightFlag;
  delay(20);
}